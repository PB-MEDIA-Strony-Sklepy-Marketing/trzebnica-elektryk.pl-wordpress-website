name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  PHP_VERSION: '8.0'
  WORDPRESS_VERSION: 'latest'

jobs:
  # ===================
  # Code Quality Checks
  # ===================
  quality-check:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, mysql
          tools: composer:v2, wp-cli, phpcs, phpmd
          
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: |
          composer install --no-progress --prefer-dist
          npm ci
          
      - name: ğŸ¨ Lint CSS
        run: npm run lint:css
        
      - name: ğŸ“ Lint JavaScript
        run: npm run lint:js
        
      - name: ğŸ˜ PHP CodeSniffer
        run: composer run phpcs
        
      - name: ğŸ”¬ PHP Mess Detector
        run: composer run phpmd
        
      - name: ğŸ”’ Security Check
        run: composer audit

  # ===================
  # Testing
  # ===================
  test:
    name: ğŸ§ª Testing
    runs-on: ubuntu-latest
    needs: quality-check
    
    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, mysql
          tools: composer:v2, wp-cli
          
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: |
          composer install --no-progress --prefer-dist
          npm ci
          
      - name: ğŸ—ï¸ Setup WordPress Test Environment
        run: |
          bash bin/install-wp-tests.sh wordpress_test root root 127.0.0.1 latest
          
      - name: ğŸ§ª Run PHP Unit Tests
        run: composer test
        
      - name: ğŸ­ Run E2E Tests
        run: npm run test:e2e:headless
        
      - name: â™¿ Accessibility Tests
        run: npm run test:a11y
        
      - name: ğŸ“Š Generate Coverage Report
        run: |
          composer test:coverage
          npm run test:coverage
          
      - name: ğŸ“¤ Upload Coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/clover.xml,./coverage/lcov.info

  # ===================
  # Performance Testing
  # ===================
  performance:
    name: ğŸš€ Performance Testing
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build assets
        run: npm run build
        
      - name: ğŸï¸ Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:8080
            http://localhost:8080/uslugi
            http://localhost:8080/kontakt
          uploadArtifacts: true
          temporaryPublicStorage: true
          
      - name: ğŸ“Š Bundle Size Check
        run: npm run analyze:ci
        
      - name: ğŸ¯ Check Performance Budget
        run: npm run budget:check

  # ===================
  # Build
  # ===================
  build:
    name: ğŸ—ï¸ Build Assets
    runs-on: ubuntu-latest
    needs: [test, performance]
    if: github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build production assets
        run: npm run build:production
        env:
          NODE_ENV: production
          
      - name: ğŸ—œï¸ Optimize images
        run: npm run optimize:images
        
      - name: ğŸ“¦ Create deployment artifact
        run: |
          tar -czf deploy.tar.gz \
            --exclude=node_modules \
            --exclude=.git \
            --exclude=tests \
            --exclude=.github \
            wp-content/themes/hubag-child
            
      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: build-artifact
          path: deploy.tar.gz
          retention-days: 7

  # ===================
  # Deploy to Staging
  # ===================
  deploy-staging:
    name: ğŸš¢ Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.trzebnica-elektryk.pl
    
    steps:
      - name: ğŸ“¥ Download artifact
        uses: actions/download-artifact@v3
        with:
          name: build-artifact
          
      - name: ğŸ”“ Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.STAGING_SSH_KEY }}
          
      - name: ğŸš€ Deploy to server
        run: |
          scp deploy.tar.gz ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }}:/tmp/
          ssh ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'EOF'
            cd /var/www/staging.trzebnica-elektryk.pl
            tar -xzf /tmp/deploy.tar.gz
            wp cache flush
            wp rewrite flush
            rm /tmp/deploy.tar.gz
          EOF
          
      - name: ğŸ”” Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Staging deployment completed!'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()

  # ===================
  # Deploy to Production
  # ===================
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://trzebnica-elektryk.pl
    
    steps:
      - name: ğŸ“¥ Download artifact
        uses: actions/download-artifact@v3
        with:
          name: build-artifact
          
      - name: ğŸ”“ Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.PRODUCTION_SSH_KEY }}
          
      - name: ğŸ“¸ Backup current version
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
            cd /var/www/trzebnica-elektryk.pl
            timestamp=$(date +%Y%m%d_%H%M%S)
            tar -czf backups/backup_$timestamp.tar.gz wp-content/themes/hubag-child
            wp db export backups/db_$timestamp.sql
          EOF
          
      - name: ğŸš€ Deploy to server
        run: |
          scp deploy.tar.gz ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }}:/tmp/
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
            cd /var/www/trzebnica-elektryk.pl
            tar -xzf /tmp/deploy.tar.gz
            wp cache flush
            wp rewrite flush
            wp sitemap regenerate
            rm /tmp/deploy.tar.gz
          EOF
          
      - name: ğŸ¥ Health check
        run: |
          response=$(curl -o /dev/null -s -w "%{http_code}\n" https://trzebnica-elektryk.pl)
          if [ $response -ne 200 ]; then
            echo "Health check failed!"
            exit 1
          fi
          
      - name: ğŸ”” Notify team
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'ğŸ‰ Production deployment completed! Site is live at https://trzebnica-elektryk.pl'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()