name: Security Scanning

on:
  schedule:
    - cron: '0 3 * * 1' # Every Monday at 3 AM
  push:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'
          tools: composer:v2
          
      - name: ğŸ“¦ Install dependencies
        run: composer install --no-dev --prefer-dist
        
      - name: ğŸ” Run WordPress Security Scan
        run: |
          # Install WPScan
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential
          sudo gem install wpscan
          
          # Run scan
          wpscan --url https://trzebnica-elektryk.pl \
                --api-token ${{ secrets.WPSCAN_API_TOKEN }} \
                --format json \
                --output wpscan-report.json
                
      - name: ğŸ›¡ï¸ Check WordPress Plugin Vulnerabilities
        run: composer audit
        
      - name: ğŸ” OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'trzebnica-elektryk.pl'
          path: '.'
          format: 'HTML'
          args: >
            --enableRetired
            --enableExperimental
            
      - name: ğŸ“Š SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          
      - name: ğŸ” Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          
      - name: ğŸ“¤ Upload Security Results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
          
      - name: ğŸ“§ Send Security Report
        if: failure()
        uses: dawidd6/action-send-mail@v6
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: 'ğŸš¨ Security Alert - trzebnica-elektryk.pl'
          to: security@pb-media.pl
          from: GitHub Actions
          body: |
            Security scan found potential vulnerabilities.
            Check the workflow run for details.